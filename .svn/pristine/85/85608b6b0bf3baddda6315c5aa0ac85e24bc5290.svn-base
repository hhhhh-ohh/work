# 互动抽奖
## 1、抽奖扣减库存
### sbc-service-mq.properties
```properties
#抽奖扣减库存
spring.cloud.stream.bindings.market-draw-stock-sub-input.destination=q.market.draw.stock.sub
spring.cloud.stream.bindings.market-draw-stock-sub-output.destination=q.market.draw.stock.sub
```

# 小程序订阅消息
## 1、发送订阅消息延迟MQ
### sbc-service-mq.properties
```properties
#发送订阅消息延迟MQ
spring.cloud.stream.bindings.send-mini-program-subscribe-msg-output.destination=q.send.subscribe.msg
spring.cloud.stream.rabbit.bindings.send-mini-program-subscribe-msg-output.producer.delayed-exchange=true
spring.cloud.stream.bindings.send-mini-program-subscribe-msg-input.destination=q.send.subscribe.msg
spring.cloud.stream.rabbit.bindings.send-mini-program-subscribe-msg-input.consumer.delayed-exchange=true
```

## 2、订阅消息跳转小程序类型
### sbc-service-empower.properties
```properties
# 订阅消息跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版
miniprogram_state=formal
```

# 组件升级
## 1、canal和dbreplay升级
由于canal1.1.6版本引入了一些新的特性，并且性能做了大幅提升，也修复了一些bug，所以对于现有的canal1.1.4进行升级，升级到1.1.6，
同时由于canal的变更，dbreplay也要进行相应的修改。
###1.1.停止原来的canal，保证kafka的数据都被消费完了停止dbreplay

###1.2.canal升级到1.1.6
* 1.下载对应的版本https://github.com/alibaba/canal/releases/download/canal-1.1.6/canal.deployer-1.1.6.tar.gz
* 2.解压
* 3.修改q
    ```properties
    canal.serverMode = kafka
    kafka.bootstrap.servers = 172.19.25.123:9092 #kafka地址
    ```

* 4.修改conf/example/instance.properties
    ```properties
    canal.instance.master.address=172.19.25.123:3306 #监听的mysql ip地址
    canal.instance.dbUsername=root
    canal.instance.dbPassword=password
    canal.instance.filter.regex=sbc-customer.company_info,sbc-goods.goods_info,sbc-goods.goods_cate,sbc-goods.goods_brand,sbc-goods.store_cate,sbc-goods.store_cate_goods_rela,sbc-goods.goods_info_spec_detail_rel,sbc-customer.customer,sbc-customer.customer_detail,sbc-customer.customer_level,sbc-customer.employee,sbc-customer.store,sbc-customer.store_customer_rela,sbc-customer.store_level,sbc-account.customer_funds,sbc-order.goods_customer_follow_action,sbc-order.purchase_action,sbc-goods.goods,sbc-goods.goods_evaluate,sbc-marketing.distribution_record,sbc-goods.goods_share_record,sbc-customer.customer_sign_record_action,sbc-customer.store_share_record,sbc-customer.store_customer_follow_action,sbc-customer.invite_new_record,sbc-customer.store_evaluate,sbc-marketing.coupon_activity,sbc-marketing.coupon_activity_config,sbc-marketing.coupon_code_0,sbc-marketing.coupon_code_1,sbc-marketing.coupon_code_2,sbc-marketing.coupon_code_3,sbc-marketing.coupon_code_4,sbc-marketing.coupon_info,sbc-marketing.booking_sale,sbc-marketing.booking_sale_goods,sbc-goods.flash_sale_goods,sbc-marketing.appointment_sale,sbc-marketing.appointment_sale_goods,sbc-goods.groupon_goods_info,sbc-goods.groupon_share_record,sbc-marketing.marketing,sbc-marketing.marketing_scope,sbc-marketing.groupon_activity,sbc-customer.customer_delivery_address,sbc-customer.customer_points_detail,sbc-customer.third_login_relation,sbc-setting.system_config,sbc-setting.platform_address,sbc-account.customer_funds,sbc-account.customer_funds_detail,sbc-marketing.coupon_marketing_scope,sbc-marketing.groupon_activity,sbc-marketing.coupon_marketing_customer_scope,sbc-goods.goods_spec,sbc-order.refund_order,sbc-customer.wechat_video_user,sbc-customer.paying_member_customer_rel,sbc-order.paying_member_record
    canal.instance.filter.black.regex=xxl-job\\..*
    canal.mq.dynamicTopic=.*\\..*
    ```

### 1.3.kafka修改
* 删除kafka的topic，新增删除脚本，vim batch-delete-topic.sh
    ```shell
    #!/bin/bash
    url=$1
    echo $url
    for i in $(/data/kafka/bin/kafka-topics.sh --bootstrap-server $url --list |grep sbc*);
    do
      /data/kafka/bin/kafka-topics.sh --bootstrap-server $url --delete -topic $i
      echo $i
    done
    ```
* 对脚本进行chmod赋权
* 执行脚本./batch-delete-topic.sh ip:9092

### 1.4.修改dbreplay
* 升级版本,dbreplay升级到2.1.0
* 将dbreplay的application.properties中，新增配置
```properties
topics.canal.replay=_
```
会将topics.canal中所有的"."替换为"_"，比如sbc-goods.goods替换为了sbc-goods_goods

### 1.5.启动canal和dbreplay
> 注意：canal 1.1.6版本发送kafka的topic将"."，替换为了"_"，所以不配套修改会报错。
> 如果有购买crm，部署了dbreplay-hadoop升级到1.1.0，或者datagalaxy需要修改topic，则对应着也需要更改

### 1.6.jenkins脚本修改
* 去除后端构建脚本中 $project-thrift-server 部分

# APP热更新
参考：http://wiki.dev.wanmi.com/display/~admin/Code+Push

## 1、环境配置（内部）
* 1、服务器按照docker部署codepush服务端
* 2、合并APP端 android 和 ios 代码
* 3、app打包平台增加配置项（本地启动也要加上这三个参数）
```
自定义后置命令上添加
\CODEPUSH_SERVER_URL:,CODEPUSH_ANDROID_KEY:,\CODEPUSH_IOS_KEY:
```
* 4、点击打包平台对应项目后面codepush按钮复制弹窗中对应参数到以上命令中
```
注意：CODEPUSH_SERVER_URL的值固定为: https://code-push.kstore.shop/
  多个环境不能公用同一个CODEPUSH_ANDROID_KEY和CODEPUSH_IOS_KEY
```
* 5、初次更新请选择构建基座，后续有js、img代码变动，请选择js\image构建
* 6、目前APP集成的是静默更新，构建成功后，APP重新打开会进行检查下载更新包（静默）
* 7、关闭APP后台进程后重新进入APP会自动更新成最新代码
* 8、如果短期内无需再更新的话，建议升级版本号进行基座更新上架
* 9、如涉及到原生的以及其他非业务代码的改动，则需要更新版本号重新进行基座更新
* 10、建议此功能只用于APP的紧急更新，更新完之后按照步骤8来一次