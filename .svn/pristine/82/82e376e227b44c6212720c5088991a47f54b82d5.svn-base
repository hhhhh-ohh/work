<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wanmi.ares.report.customer.dao.CustomerGrowthReportMapper">
    <resultMap id="customerReport" type="com.wanmi.ares.report.customer.model.root.CustomerGrowthReport">
        <id property="id" column="id"/>
        <result property="baseDate" column="base_date"/>
        <result property="customerAllCount" column="customer_all_count"/>
        <result property="customerDayGrowthCount" column="customer_day_growth_count"/>
        <result property="customerDayRegisterCount" column="customer_day_register_count"></result>
        <result property="companyId" column="company_id"></result>
        <result property="createDate" column="create_tm"></result>
    </resultMap>

    <sql id="commonAddColSql">
        id,base_date, customer_all_count,customer_day_growth_count, customer_day_register_count, company_id, create_tm
    </sql>

    <insert id="saveCustomerGrowthReport">
        INSERT INTO customer_grow (<include refid="commonAddColSql"/>) VALUES
        <foreach collection="customerGrowthReportList" item="item" index="index" separator=",">
            (
            uuid(), #{item.baseDate}, #{item.customerAllCount}, #{item.customerDayGrowthCount},
            #{item.customerDayRegisterCount}
            , #{item.companyId}, now()
            )
        </foreach>
    </insert>

    <select id="findPreCustomerAllCount" resultMap="customerReport">
        SELECT
        id,
        base_date ,
        customer_all_count,
        customer_day_growth_count,
        customer_day_register_count,
        company_id,
        create_tm
        FROM customer_grow where base_date= #{preDate} and company_id = #{companyId}
    </select>

    <select id="findAllCustomerGrowReport" resultMap="customerReport">
        <!--SELECT
        base_date,
        sum(customer_all_count) as customer_all_count,
        sum(customer_day_growth_count) as customer_day_growth_count,
        sum(customer_day_register_count) as customer_day_register_count
        from customer_grow where
        <![CDATA[
              base_date >= #{customerGrowthReportRequest.startDate} and base_date <= #{customerGrowthReportRequest.enDate}
              and (#{customerGrowthReportRequest.companyId} is null or company_id = #{customerGrowthReportRequest.companyId})
        ]]>
        group by base_date
        <if test="customerGrowthReportRequest.sortField != null">
            order by ${customerGrowthReportRequest.sortField} ${customerGrowthReportRequest.sortTypeText}
        </if>
        limit #{pageRequest.start} , #{pageRequest.pageSize}-->


        SELECT
        c.base_date,
        sum(c.customer_all_count) as customer_all_count,
        sum(c.customer_day_growth_count) as customer_day_growth_count,
        sum(c.customer_day_register_count) as customer_day_register_count
        FROM customer_grow c
        LEFT JOIN replay_store r
        on c.company_id = r.company_info_id
        where
        base_date >= #{customerGrowthReportRequest.startDate}
        and base_date &lt;= #{customerGrowthReportRequest.enDate}
        <if test="customerGrowthReportRequest.companyId != null and customerGrowthReportRequest.companyId != ''">
            and (#{customerGrowthReportRequest.companyId} is null or c.company_id=
            #{customerGrowthReportRequest.companyId})
        </if>
        GROUP BY c.base_date
        <if test="customerGrowthReportRequest.sortField != null">
            order by ${customerGrowthReportRequest.sortField} ${customerGrowthReportRequest.sortTypeText}
        </if>
        limit #{pageRequest.start,jdbcType=INTEGER} , #{pageRequest.pageSize,jdbcType=INTEGER}
    </select>

    <select id="findAllCustomerGrowReportByStoreType" resultMap="customerReport">
        SELECT
        c.base_date,
        sum(c.customer_all_count) as customer_all_count,
        sum(c.customer_day_growth_count) as customer_day_growth_count,
        sum(c.customer_day_register_count) as customer_day_register_count
        FROM customer_grow c
        LEFT JOIN replay_store r
        on c.company_id = r.company_info_id
        where
        base_date >= #{customerGrowthReportRequest.startDate}
        and base_date &lt;= #{customerGrowthReportRequest.enDate}
        and r.store_type = #{storeSelectType}
        and c.company_id != 0
        GROUP BY c.base_date
        <if test="customerGrowthReportRequest.sortField != null">
            order by ${customerGrowthReportRequest.sortField} ${customerGrowthReportRequest.sortTypeText}
        </if>
        limit #{pageRequest.start,jdbcType=INTEGER} , #{pageRequest.pageSize,jdbcType=INTEGER}
    </select>

    <select id="countCustomerReport" resultType="java.lang.Integer">
        select count(DISTINCT (c.base_date))
        FROM customer_grow c
        LEFT JOIN replay_store r
        on c.company_id = r.company_info_id
        where
        <![CDATA[
              c.base_date >= #{customerGrowthReportRequest.startDate} and c.base_date <= #{customerGrowthReportRequest.enDate}
            ]]>
        <if test="customerGrowthReportRequest.companyId != null and customerGrowthReportRequest.companyId != ''">
            and (#{customerGrowthReportRequest.companyId} is null or c.company_id=
            #{customerGrowthReportRequest.companyId})
        </if>
    </select>

    <select id="countCustomerReportByStoreType" resultType="java.lang.Integer">
        select count(DISTINCT (c.base_date))
        FROM customer_grow c
        LEFT JOIN replay_store r
        on c.company_id = r.company_info_id
        where
        <![CDATA[
              c.base_date >= #{customerGrowthReportRequest.startDate} and c.base_date <= #{customerGrowthReportRequest.enDate}
            ]]>
        and r.store_type = #{storeSelectType}
        and c.company_id != 0
    </select>


    <select id="findCustomerGrowthReportByDate" resultMap="customerReport">
        SELECT
        c.base_date,
        sum(c.customer_all_count) as customer_all_count,
        sum(c.customer_day_growth_count) as customer_day_growth_count,
        sum(c.customer_day_register_count) as customer_day_register_count
        FROM customer_grow c
        LEFT JOIN replay_store r
        on c.company_id = r.company_info_id
        where
        c.base_date >= #{startDate} and c.base_date &lt;= #{endDate}
        and c.company_id= #{companyId}
        GROUP BY c.base_date
        order by c.base_date asc
    </select>

    <select id="findCustomerGrowthReportByDateAndStoreType" resultMap="customerReport">
        SELECT
        c.base_date,
        sum(c.customer_all_count) as customer_all_count,
        sum(c.customer_day_growth_count) as customer_day_growth_count,
        sum(c.customer_day_register_count) as customer_day_register_count
        FROM customer_grow c
        LEFT JOIN replay_store r
        on c.company_id = r.company_info_id
        where
        c.base_date >= #{startDate} and c.base_date &lt;= #{endDate}
        and r.store_type = #{storeSelectType}
        and c.company_id != 0
        GROUP BY c.base_date
        order by c.base_date asc
    </select>

    <!--查询平台趋势报表-->
    <select id="findAllCustomerGrowthReportByDate" resultMap="customerReport">
        SELECT
        base_date ,
        sum(customer_all_count) as customer_all_count,
        sum(customer_day_growth_count) as customer_day_growth_count,
        sum(customer_day_register_count) as customer_day_register_count,
        min(create_tm) as create_tm
        FROM customer_grow where
            <![CDATA[
                base_date >= #{startDate} and base_date <= #{endDate}
            ]]>
        group by base_date
        order by base_date asc
    </select>

    <delete id="deleteCustomerGrowthReportByDate">
        delete from customer_grow WHERE base_date=#{deleteDate}
    </delete>
</mapper>