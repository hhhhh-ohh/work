<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wanmi.ares.report.employee.dao.ReplayStoreCustomerRelaMapper">
  <resultMap id="BaseResultMap" type="com.wanmi.ares.report.employee.model.root.ReplayStoreCustomerRela">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="customer_id" jdbcType="VARCHAR" property="customerId" />
    <result column="store_id" jdbcType="BIGINT" property="storeId" />
    <result column="company_info_id" jdbcType="INTEGER" property="companyInfoId" />
    <result column="store_level_id" jdbcType="BIGINT" property="storeLevelId" />
    <result column="employee_id" jdbcType="VARCHAR" property="employeeId" />
    <result column="customer_type" jdbcType="TINYINT" property="customerType" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="total" jdbcType="BIGINT" property="total" />
  </resultMap>

  <select id="selectTotal" resultMap="BaseResultMap" parameterType="java.util.Map">
    select
      r.id as id,
      r.customer_id as customer_id,
      r.store_id as store_id,
      r.company_info_id as company_info_id,
      r.store_level_id as store_level_id,
      r.employee_id,
      r.customer_type as customer_type,
      r.create_time as create_time,
      t.total
      from replay_store_customer_rela r,
        (select
          min(a.id) as id,
          a.employee_id,
          count(1) as total
        from replay_store_customer_rela a
        inner JOIN replay_customer b ON a.customer_id = b.customer_id AND b.check_state = 1
        WHERE  a.employee_id is not null
        AND a.employee_id != ''
        <if test="startTime != null and endTime != null">
          and a.create_time  between  #{startTime} and #{endTime}
        </if>
        <if test="employeeId != null">
          and a.employee_id = #{employeeId}
        </if>
        GROUP BY a.employee_id) t WHERE r.id = t.id
  </select>

  <select id="findTotal" resultType="java.util.Map" parameterType="java.util.Map">
    SELECT
	c.employee_id, count(1) as total
    FROM
	replay_customer a
	INNER JOIN replay_customer_detail b ON a.customer_id = b.customer_id
    <if test="startTime != null and endTime != null">
	  and a.check_time BETWEEN #{startTime} and #{endTime}
    </if>
	INNER JOIN replay_employee c ON b.employee_id = c.employee_id
    WHERE
	c.account_type = 1
    <if test="employeeId != null">
      and c.employee_id = #{employeeId}
    </if>
	GROUP BY c.employee_id
  </select>
</mapper>